<html>
<head>
	<title>CloudBoard</title>
	<script type="text/javascript">
		var showingCache = false;
		function openLink(url) {
			chrome.tabs.create({url: url});
		}
        function refresh(force) {
            if (force) {
                document.getElementById("new").style.display = "none";  
                document.getElementById("container").style.display = "block";
                document.getElementById("inbox").style.display = "none";
                document.getElementById("loading").style.display = "block";
                getInboxFromServer(displayInbox);
            } else {
                getIfUpdated(function(update) {
                    if (!update && localStorage.getItem("com.jhartig.cloudboard.inboxCache") != null) {
                        if (!showingCache) { //if this is true then we don't need to update
                            displayInbox(localStorage.getItem("com.jhartig.cloudboard.inboxCache"));
                            showingCache = true;
                        }
                    } else {
                        document.getElementById("new").style.display = "none";  
                        document.getElementById("container").style.display = "block";
                        document.getElementById("inbox").style.display = "none";
                        document.getElementById("loading").style.display = "block";
                        getInboxFromServer(displayInbox);
                        showingCache = true;
                    }
                });
            }
        }
        
        function displayInbox(json) {
            
            document.getElementById("inbox").innerHTML = json;
            
            document.getElementById("loading").style.display = "none";
            document.getElementById("inbox").style.display = "block";
        }
        
        function getIfUpdated(callback) {
    	    if (localStorage.getItem("com.jhartig.cloudboard.authToken") && localStorage.getItem("com.jhartig.cloudboard.authToken") != "invalid_token") { //only send if we have an authToken
        		
                if (localStorage.getItem("com.jhartig.cloudboard.lastUpdated")) {                
                    var xhr = new XMLHttpRequest();
            		xhr.onreadystatechange = function (xhr) { handleIfUpdatedResponse(xhr, callback); };
            		xhr.open("GET", "http://cloudboard.jhartig.com/lastUpdate.php?token="+localStorage.getItem("com.jhartig.cloudboard.authToken")+"&version=1", true);
            		xhr.send();
                } else {
                    console.error("wtf");
                    callback(true);
                }
           } else {
                document.getElementById("container").style.display = "none";
                document.getElementById("fail").style.display = "block";
           }
    	}
	
    	function handleIfUpdatedResponse(xhr, callback) {
    	    if (!xhr.readyState) {
    	       xhr = xhr.target;
    	    }
    		if (xhr.readyState == 4) {
    			var resp = xhr.responseText;
                if (resp == "invalid_token") {
                    localStorage.setItem("com.jhartig.cloudboard.authToken", resp);
                    document.getElementById("container").style.display = "none";
                    document.getElementById("fail").style.display = "block";
                } else {
                    var time = parseInt(resp);
                    if (!time || time > localStorage.getItem("com.jhartig.cloudboard.lastUpdated")) {
                        callback(true);
                    } else {
                        callback(false);
                    }
                }
    		}
    	}
        
        function getInboxFromServer(callback) {
    	    if (localStorage.getItem("com.jhartig.cloudboard.authToken") && localStorage.getItem("com.jhartig.cloudboard.authToken") != "invalid_token") { //only send if we have an authToken
                var xhr = new XMLHttpRequest();
        		xhr.onreadystatechange = function (xhr) { handleInboxResponse(xhr, callback); };
        		xhr.open("GET", "http://cloudboard.jhartig.com/inbox.php?token="+localStorage.getItem("com.jhartig.cloudboard.authToken")+"&version=1", true);
        		xhr.send();
           } else {
                document.getElementById("container").style.display = "none";
                document.getElementById("fail").style.display = "block";
           }
    	}
	
    	function handleInboxResponse(xhr, callback) {
    	    if (!xhr.readyState) {
    	       xhr = xhr.target;
    	    }
    		if (xhr.readyState == 4) {
    			var resp = xhr.responseText;
                if (resp == "invalid_token") {
                    localStorage.setItem("com.jhartig.cloudboard.authToken", resp);
                    document.getElementById("container").style.display = "none";
                    document.getElementById("fail").style.display = "block";
                } else {
                    localStorage.setItem("com.jhartig.cloudboard.lastUpdated", Math.round(new Date().getTime() / 1000)); //get unix timestamp
                    localStorage.setItem("com.jhartig.cloudboard.inboxCache", resp);
                    callback(resp);
                }
    		}
    	}
        
        function openNew() {
            document.getElementById("container").style.display = "none";
            document.getElementById("new").style.display = "block";
            document.getElementById("form-error").style.display = "none";
        }
        
        function uploadText(form) {
            if (form.text && (form.text.value).length > 0) {
                chrome.extension.sendRequest({data: form.text.value, type:'txt'}, function (response) {
                    if (response) {
                        form.text.value = "";
                        document.getElementById("form-error").style.display = "none";
                    } else {
                        document.getElementById("form-error").style.display = "block";
                    }
                });
            }
        }
        
        function loaded() {
            
            if (!localStorage.getItem("com.jhartig.cloudboard.authToken") || localStorage.getItem("com.jhartig.cloudboard.authToken") == "invalid_token") {
                document.getElementById("container").style.display = "none";
                document.getElementById("fail").style.display = "block";
    			//var urlFrame = "http://cloudboard.jhartig.com/inbox.php?token="+localStorage.getItem("com.jhartig.cloudboard.authToken")+"&version=1";
    		} else {
                refresh();
            }
        }
        function iframeloaded() {
            document.getElementById("loading").style.display = "none";
            document.getElementById("iframe").style.height = "308px";
        }
        
        function fitContent(id, maxHeight) {
           var text = id && id.style ? id : document.getElementById(id);
           if (!text) return;
           text.style.height = "14px";
           var adjustedHeight = text.scrollHeight;
           if (maxHeight) adjustedHeight = Math.min(maxHeight, adjustedHeight);
           text.style.height = adjustedHeight + "px";
        }
	</script>
</head>
<body style="width:300;height:320px;margin:2px 4px;" onload="loaded();">
    <div id="fail" style="display:none;">
        <p>You must get an authToken before using Cloudboard. <a href="options.html" onclick="openLink('options.html');">Options</a></p>
    </div>
    <div id="container" style="height:320px;">
        <span style="position:absolute;right:4px;top:2px;font-size:11px;"><a href="#" onclick="refresh(true);">Refresh</a></span>
        <span style="position:absolute;left:4px;top:2px;font-size:11px;"><a href="#" onclick="openNew();">Paste New</a></span>
        
        <div id="loading"><p style="height:20px;width:100px;margin-left:auto;margin-right:auto;"><img src="ajax-loader.gif" /></p></div>
        <div id="inbox" style="display:none; height:300px; margin-top: 28px;">
        
        </div>
    </div>
    <div id="new" style="height:308px;width:300px;margin-top:12px; padding-top:8px;display:none;">    
        <form onsubmit="uploadText(this); return false;">
            <span>Paste Content here</span>
            <p style="color: red;display:none;" id="form-error">Please try again.</p>
            <textarea style="height:200px;width:280;margin-left:auto;margin-right:auto;" name="text"></textarea>
            <input type="submit" value="Submit" />
        </form>
    </div>
</body>
</html>