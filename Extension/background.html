<html>
    <script type="text/javascript">
	function setupContexts() {
		chrome.contextMenus.create( {
			"title": "Copy to Cloudboard",
			"contexts": ["selection"],
			"onclick": getCopiedData
		} );
		chrome.contextMenus.create( {
			"title": "Copy Link to Cloudboard",
			"contexts": ["link"],
			"onclick": getCopiedData
		} );
		chrome.contextMenus.create( {
			"title": "Copy Page to Cloudboard",
			"contexts": ["page"],
			"onclick": getCopiedData
		} );
		chrome.contextMenus.create( {
			"title": "Copy Image URL to Cloudboard",
			"contexts": ["image"],
			"onclick": getCopiedData
		} );
        chrome.contextMenus.create( {
			"title": "Paste From Cloudboard",
			"contexts": ["editable"],
			"onclick": pasteEditableData
		} );
	}
	
	function getCopiedData(info, tab) {
		var data, type;
		if (info.linkUrl) {
			console.log("Got link", info.linkUrl);
			data = info.linkUrl;
			type = "lnk";
		} else if (info.srcUrl) {
			console.log("Got image", info.srcUrl);
			data = info.srcUrl;
			type = "img";
		} else if (info.selectionText) {
			console.log("Got text", info.selectionText);
			data = info.selectionText;
			type = "txt";
		} else if (info.pageUrl) {
			console.log("Got page URL", info.pageUrl);
			data = info.pageUrl;
			type = "pg";
		}
		if (data) {
			sendDataToServer(data, type, function (response) {
                if (!response) {
                    chrome.tabs.executeScript(tab.id, {code: 'alert("Could not copy to Cloudboard. Try again in a few. If the problem persists, contact me: cloudboard@jhartig.com.");'});
                }
			});;
		}
	}
    
    function pasteEditableData(info, tab) {
        //make sure we get the data from the server now
        var time = Math.round(new Date().getTime() / 1000);
                
        var callback = function(data) {
            if (data && data[0]) {
                var paste = (data[0].text).replace(/"/g, '\\"').replace(/\n/g, '');
                chrome.tabs.executeScript(tab.id, {code: 'if (document.activeElement.selectionStart) { document.activeElement.value = (document.activeElement.value).substr(0,document.activeElement.selectionStart)+"'+paste+'"+(document.activeElement.value).substr(document.activeElement.selectionEnd); } else { document.activeElement.value += "'+paste+'"; }'});
            }
        };
        
        if (time <= parseInt(localStorage.getItem("com.jhartig.cloudboard.lastUpdated"))+1) {
            getInboxFromCache(callback);
        } else {
            getInboxFromServer(callback);
        }
    }
    
    var lastPaste = null;
	
	function sendDataToServer(data, type, callback) {
	    if (localStorage.getItem("com.jhartig.cloudboard.authToken") && localStorage.getItem("com.jhartig.cloudboard.authToken") != "invalid_token") { //only send if we have an authToken
    		var params = data;
    		var xhr = new XMLHttpRequest();
    		xhr.onreadystatechange = function (xhr) { handleServerResponse(xhr, callback); };
    		xhr.open("POST", "http://cloudboard.jhartig.com/post.php?token="+localStorage.getItem("com.jhartig.cloudboard.authToken")+"&type="+type+"&version=1", true);
    		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); //we need this for some reason
            xhr.send(params);
            lastPaste = data;
       }
	}
	
	function handleServerResponse(xhr, callback) {
	    if (!xhr.readyState) {
	       xhr = xhr.target;
	    }
		if (xhr.readyState == 4) {
			var resp = xhr.responseText;
            if (resp == "true" || resp == "dup" ) {
                if (callback) {
                    callback(true);
                }
            } else if (resp == "invalid_token") {
                localStorage.setItem("com.jhartig.cloudboard.authToken", resp);
                openLink("options.html");
                if (callback) {
                    callback(false);
                }
            } else {
                if (callback) {
                    callback(false);
                }
            }
		}
	}
    
    function checkConnectionStatus() {
        if (openConnection) {
            aborted = true; //tell us not to restart connection on error
            openConnection.abort();
            console.error("connection aborted after time limit");
            openConnection = false;
            openServerConnection(); //reopen            
        }
    }
    
    var disconnectedOnIdle = false;
    var aborted = false;
    
    function checkIdleState() {
        chrome.idle.queryState(600, function (state) {
           if ((state == "idle" || state == "locked") && openConnection) {
               clearTimeout(timeout);
               aborted = true; //tell us not to restart connection on error
               openConnection.abort();
               openConnection = false;               
               console.error("connection aborted because computer is idle");
               disconnectedOnIdle = true;
           } else if (state == "active" && disconnectedOnIdle && !openConnection) { //they are back
               console.log("connection reopened after not idle");
               openServerConnection();
               disconnectedOnIdle = false;
           }
        });
        //see if they changed the notification setting
        if (openConnection && localStorage.getItem("com.jhartig.cloudboard.notifications") == 0) {
            clearTimeout(timeout);
            aborted = true; //tell us not to restart connection on error
            openConnection.abort();
            openConnection = false;
            console.error("connection aborted because changed setting");
        } else if (!openConnection && localStorage.getItem("com.jhartig.cloudboard.notifications") == 1 && !aborted) {
            console.log("changed notification setting");
            openServerConnection();            
        }
    }
    
    var openConnection = false;
    var timeout = false;

    function openServerConnection() {
        if (!openConnection && localStorage.getItem("com.jhartig.cloudboard.notifications") == 1) {
            console.log("opening connection");
            aborted = false;
            if (localStorage.getItem("com.jhartig.cloudboard.authToken") && localStorage.getItem("com.jhartig.cloudboard.authToken") != "invalid_token") { //only send if we have an authToken
        		openConnection = new XMLHttpRequest();
        		openConnection.onreadystatechange = function (xhr) { handleListenResponse(xhr); };
        		openConnection.open("GET", "http://cloudboard.jhartig.com/listen.php?token="+localStorage.getItem("com.jhartig.cloudboard.authToken")+"&version=1", true);
                openConnection.send();
                if (timeout) { clearTimeout(timeout); }
                timeout = setTimeout(checkConnectionStatus, 900000); //close connection after 15 minutes (900000)
           }
       }
    }
    
    function handleListenResponse(xhr) {
        if (!xhr.readyState) {
	       xhr = xhr.target;            
        }
		if (xhr.readyState == 4) {
			var resp = xhr.responseText;
            openConnection = false;
            if (xhr.responseText == "invalid_token") {
                localStorage.setItem("com.jhartig.cloudboard.authToken", resp);
            } else if (xhr.status == 200) {                
                resp = resp.substr(1); //remove inital "-" that was echoed to fake lighttpd into thinking we started response
                console.log("got resp", resp);
                try {
                    resp = JSON.parse(resp);
                } catch (e) {}
                if (resp && resp.text && localStorage.getItem("com.jhartig.cloudboard.inboxCache")) {
                    var inboxCache = localStorage.getItem("com.jhartig.cloudboard.inboxCache");
                    try {
                        inboxCache = JSON.parse(inboxCache);
                    } catch (e) {
                        getInboxFromServer(function (inbox) {
                            if (inbox && inbox[0]) {
                                if (inbox[0].text != lastPaste) {
                                    var notification = webkitNotifications.createNotification(
                                      'icon48.png',
                                      'New Cloudboard Paste',
                                      inbox[0].text
                                    );
                                    notification.show();
                                }
                            }
                        });
                    }
                    inboxCache.unshift(resp); //add the new item
                    if (inboxCache.length > 10) {
                        inboxCache.pop();
                    }
                    localStorage.setItem("com.jhartig.cloudboard.inboxCache", JSON.stringify(inboxCache));
                    localStorage.setItem("com.jhartig.cloudboard.lastUpdated", Math.round(new Date().getTime() / 1000)); //get unix timestamp
                    if (resp.text != lastPaste) {
                        var notification = webkitNotifications.createNotification(
                          'icon48.png',
                          'New Cloudboard Paste',
                          resp.text
                        );
                        notification.show();
                    }         
                }
                clearTimeout(timeout);
                openServerConnection();
            } else if (!aborted) {
                if (xhr.responseText) { console.error("received error: ", xhr.responseText); }
                clearTimeout(timeout);
                setTimeout(openServerConnection, 2000); //resume in 2 seconds because we got an error, even though this is probably ok                
            }
		}
	}
    
    chrome.extension.onRequest.addListener(
        function(request, obj, callback) {
            if (request == "ifUpdated") {
                getIfUpdated(callback);
            } else if (request == "getInbox") {
                getInboxFromServer(callback);
            } else if (request == "getCacheInbox") {
                getInboxFromCache(callback);
            } else {
                sendDataToServer(request.data, (request.type ? request.type : 'txt'), callback);
            }
        }
    );
	
	function openLink(url) {
		chrome.tabs.create({url: url});
	}
	
	function openOptions() {
		if (!localStorage.getItem("com.jhartig.cloudboard.authToken") || localStorage.getItem("com.jhartig.cloudboard.authToken") == "invalid_token") {
			openLink("options.html");
		}
	}
    
    function getIfUpdated(callback) {
    	    if (localStorage.getItem("com.jhartig.cloudboard.authToken") && localStorage.getItem("com.jhartig.cloudboard.authToken") != "invalid_token") { //only send if we have an authToken
                if (localStorage.getItem("com.jhartig.cloudboard.lastUpdated")) {                
                    var xhr = new XMLHttpRequest();
            		xhr.onreadystatechange = function (xhrr) { handleIfUpdatedResponse(xhrr, callback); };
            		xhr.open("GET", "http://cloudboard.jhartig.com/lastUpdate.php?token="+localStorage.getItem("com.jhartig.cloudboard.authToken")+"&version=1", true);
            		xhr.send();
                } else {
                    callback(true);
                }
           } else {
                callback("invalid_token");
           }
    	}
	
    function handleIfUpdatedResponse(xhr, callback) {
	    if (!xhr.readyState) {
	       xhr = xhr.target;
	    }
		if (xhr.readyState == 4) {
			var resp = xhr.responseText;
            if (resp == "invalid_token") {
                localStorage.setItem("com.jhartig.cloudboard.authToken", resp);
                callback("invalid_token");
            } else {
                var time = parseInt(resp);
                if (!time || time > parseInt(localStorage.getItem("com.jhartig.cloudboard.lastUpdated"))) {
                    callback(true);
                } else {
                    callback(false);
                }
            }
		}
	}
    
    function getInboxFromServer(callback) {
	    if (localStorage.getItem("com.jhartig.cloudboard.authToken") && localStorage.getItem("com.jhartig.cloudboard.authToken") != "invalid_token") { //only send if we have an authToken
            var xhr = new XMLHttpRequest();
    		xhr.onreadystatechange = function (xhr) { handleInboxResponse(xhr, callback); };
    		xhr.open("GET", "http://cloudboard.jhartig.com/inbox.php?token="+localStorage.getItem("com.jhartig.cloudboard.authToken")+"&version=1", true);
    		xhr.send();
       } else {
            callback("invalid_token");
       }
	}

	function handleInboxResponse(xhr, callback) {
	    if (!xhr.readyState) {
	       xhr = xhr.target;
	    }
		if (xhr.readyState == 4) {
			var resp = xhr.responseText;
            if (resp == "invalid_token") {
                localStorage.setItem("com.jhartig.cloudboard.authToken", resp);
                if (callback) {
                    callback("invalid_token");
                }
            } else {
                localStorage.setItem("com.jhartig.cloudboard.lastUpdated", Math.round(new Date().getTime() / 1000)); //get unix timestamp
                localStorage.setItem("com.jhartig.cloudboard.inboxCache", resp);
                try {
                    resp = JSON.parse(resp);
                } catch (e) {}
                if (callback) {
                    callback(resp);
                }
            }
		}
	}
    
    function getInboxFromCache(callback) {
        var resp = localStorage.getItem("com.jhartig.cloudboard.inboxCache");
        try {
            resp = JSON.parse(resp);
        } catch (e) {}
        callback(resp);
    }
	
	setupContexts();
	openOptions();
    
    getInboxFromServer(); //start off with a new inbox
    if (localStorage.getItem("com.jhartig.cloudboard.notifications") == null) {
        localStorage.setItem("com.jhartig.cloudboard.notifications", 1); //new users
    }
    if (localStorage.getItem("com.jhartig.cloudboard.notifications") != 0) {
        openServerConnection();
        setInterval(checkIdleState, 5000);
    }
    </script>
</html>